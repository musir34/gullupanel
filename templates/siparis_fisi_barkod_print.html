<!DOCTYPE html>
<html>
<head>
  <title>Barkod Etiketleri Yazdırma - Güllü Ayakkabı (A4 - 21 Etiket, 60x38mm)</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      width: 210mm;
      height: 297mm;
      margin: 0;
      padding: 0;
      background: #fff;
      box-sizing: border-box;
      overflow: hidden;
    }
    body {
      font-family: Arial, Helvetica, sans-serif;
      color: #333;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    .print-area {
      width: 210mm;
      height: 297mm;
      display: grid;
      grid-template-columns: repeat(3, 60mm);
      grid-template-rows: repeat(7, 38mm);
      gap: 0;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      background: #fff;
      overflow: hidden;
    }
    .barcode-label {
      width: 60mm !important;
      height: 38mm !important;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      border: none !important;
      padding: 0 !important;
      margin: 0 !important;
      overflow: hidden;
      background: #fff !important;
      position: relative;
    }
    .left-block {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 50%;
      height: 100%;
      box-sizing: border-box;
      /* Tam ortalamak için flex kullanıldı */
    }
    .qr-image {
      display: block;
      max-width: 18mm;
      max-height: 18mm;
      margin-bottom: 2mm;
      margin-top: 2mm;
      object-fit: contain;
    }
    .barcode-text-under-qr {
      font-size: 8pt;
      text-align: center;
      margin: 0;
      padding: 0;
      word-break: break-all;
      width: 100%;
      letter-spacing: 1px;
    }
    .right-block {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 50%;
      height: 100%;
      font-size: 8.3pt;
      box-sizing: border-box;
      padding-left: 2mm;
      padding-right: 2mm;
      text-align: center;
    }
    .right-block div {
      margin-bottom: 2.5mm;
      font-size: 8pt;
    }
    .right-block div:last-child {
      margin-bottom: 0;
    }
    .print-status-icon {
      position: absolute;
      top: 1.5mm;
      left: 1.5mm;
      font-size: 10px;
      color: #28a745;
      font-weight: 700;
      z-index: 10;
      display: none;
    }
    .barcode-label.printed .print-status-icon { display: block; }
    .no-print, .print-button, .nav-buttons { display: none !important; }
    @media print {
      html, body {
        width: 210mm;
        height: 297mm;
        margin: 0;
        padding: 0;
        background: #fff;
        box-sizing: border-box;
        overflow: hidden;
      }
      .print-area {
        width: 210mm;
        height: 297mm;
        display: grid;
        grid-template-columns: repeat(3, 60mm);
        grid-template-rows: repeat(7, 38mm);
        gap: 0;
        margin: 0;
        padding: 0;
        background: #fff;
      }
      .barcode-label {
        width: 60mm !important;
        height: 38mm !important;
        border: none !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      .no-print, .print-button, .nav-buttons { display: none !important; }
    }
  </style>
</head>
<body data-siparis-id="{{ siparis_id }}">
  <h1 class="no-print">Barkod Etiketleri Hazırlanıyor...</h1>
  <div class="no-print" style="text-align:center">
    <div id="loading-message">QR Kodlar Yükleniyor... Lütfen Bekleyin.</div>
    <button id="printAllButton" class="print-button" disabled>Tümünü Yazdır</button>
  </div>
  <div class="print-area">
    {% set i = 0 %}
    {% for item in barcodes %}
      {% for j in range(item.print_count) %}
        {% if i < 21 %}
        <div class="barcode-label {% if item.is_printed %}printed{% endif %}" data-barcode="{{ item.barcode }}">
          <span class="print-status-icon">✔</span>
          <div class="left-block">
            <img class="qr-image" src="{{ item.qr_image_path }}" alt="QR Kod: {{ item.barcode }}">
            <div class="barcode-text-under-qr">{{ item.barcode }}</div>
          </div>
          <div class="right-block">
            <div>Model: {{ item.model }}</div>
            <div>Renk: {{ item.color }}</div>
            <div>Beden: {{ item.size }}</div>
          </div>
        </div>
        {% set i = i + 1 %}
        {% endif %}
      {% endfor %}
    {% endfor %}
  </div>
  <div class="nav-buttons no-print">
    <a href="{{ url_for('home.home') }}">Ana Sayfa</a>
    <a href="{{ url_for('siparis_fisi_bp.siparis_fisi_sayfasi') }}">Sipariş Fişleri</a>
  </div>
  <script>
    const qrImages       = document.querySelectorAll('.qr-image');
    const loadingMessage = document.getElementById('loading-message');
    const printAllBtn    = document.getElementById('printAllButton');
    const allBarcodesInTemplate = [...document.querySelectorAll('.barcode-label')].map(el => el.dataset.barcode);
    const uniqueBarcodesToMark = [...new Set(allBarcodesInTemplate)];
    let loadedImages = 0;
    const totalImages = qrImages.length;
    function checkAllLoaded(){
      loadedImages++;
      if(loadedImages === totalImages){
        loadingMessage.style.display='none';
        printAllBtn.disabled = false;
      }
    }
    if(totalImages === 0){
      loadingMessage.style.display='none';
      printAllBtn.disabled=true;
    } else {
      qrImages.forEach(img=>{
        img.addEventListener('load', checkAllLoaded, {once:true});
        img.addEventListener('error', checkAllLoaded, {once:true});
        if(img.complete) setTimeout(checkAllLoaded, 0);
      });
    }
    const siparisId = Number(document.body.dataset.siparisId||0);
    async function sendPrintStatus(list_of_barcodes){
      if(!siparisId || !list_of_barcodes || list_of_barcodes.length === 0) return;
      try{
        const url = "{{ url_for('siparis_fisi_bp.mark_as_printed') }}";
        const response = await fetch(url, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({siparis_id: siparisId, barcodes: list_of_barcodes})
        });
        if(response.ok){
          const responseData = await response.json();
          if(responseData.success) {
            if (responseData.added && Array.isArray(responseData.added)) {
              responseData.added.forEach(bc=>{
                document.querySelectorAll(`.barcode-label[data-barcode="${bc}"]`).forEach(lbl=>lbl.classList.add('printed'));
              });
            }
          }
        }
      }catch(e){}
    }
    let printJobActive = false;
    printAllBtn.addEventListener('click',()=>{
      printJobActive = true;
      window.print();
    });
    window.onafterprint = ()=>{
      if (!printJobActive) return;
      sendPrintStatus(uniqueBarcodesToMark);
      printJobActive = false;
    };
  </script>
</body>
</html>
