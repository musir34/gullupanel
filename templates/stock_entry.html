{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Stok Girişi</h2>
    <div class="form-group">
        <label for="barcodeInput">Barkod Okut:</label>
        <input type="text" class="form-control" id="barcodeInput" autofocus>
    </div>

    <div id="scannedBarcodes" class="mt-3">
        <h4>Okutulan Barkodlar:</h4>
        <ul id="barcodeList" class="list-group">
            </ul>
    </div>

    <div class="mt-4">
        <button id="refreshStockBtn" class="btn btn-primary mr-2">Raftaki Stokları Yenile</button>
        <button id="addNewStockBtn" class="btn btn-success">Yeni Gelenleri Ekle</button>
    </div>
</div>

<script>
    var scannedBarcodes = {}; // Barkod sayılarını tutacak obje

    document.getElementById('barcodeInput').addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault(); // Form gönderimini engelle
            var barcode = this.value.trim();
            if (barcode) {
                addBarcode(barcode);
                this.value = ''; // Giriş alanını temizle
            }
        }
    });

    function addBarcode(barcode) {
        if (scannedBarcodes[barcode]) {
            scannedBarcodes[barcode]++;
        } else {
            scannedBarcodes[barcode] = 1;
        }
        updateBarcodeList();
    }

    function updateBarcodeList() {
        var barcodeList = document.getElementById('barcodeList');
        barcodeList.innerHTML = ''; // Mevcut listeyi temizle

        for (var barcode in scannedBarcodes) {
            if (scannedBarcodes.hasOwnProperty(barcode)) {
                var listItem = document.createElement('li');
                listItem.classList.add('list-group-item');
                listItem.textContent = barcode + ': ' + scannedBarcodes[barcode] + ' adet';
                barcodeList.appendChild(listItem);
            }
        }
    }

    document.getElementById('refreshStockBtn').addEventListener('click', function() {
        sendStockUpdate('refresh');
    });

    document.getElementById('addNewStockBtn').addEventListener('click', function() {
        sendStockUpdate('add');
    });

    function sendStockUpdate(updateType) {
        if (Object.keys(scannedBarcodes).length === 0) {
            alert('Lütfen önce barkod okutun.');
            return;
        }

        fetch('/stock_update', { // Flask'ta oluşturulacak olan rota
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                barcodes: scannedBarcodes,
                update_type: updateType
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Stok başarıyla güncellendi.');
                scannedBarcodes = {}; // Başarılı olursa okutulan barkodları temizle
                updateBarcodeList(); // Görüntülenen listeyi güncelle
            } else {
                alert('Stok güncellenirken bir hata oluştu: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            alert('Bir hata oluştu, lütfen tekrar deneyin.');
        });
    }
</script>
{% endblock %}